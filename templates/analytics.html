{% extends "base.html" %}

{% block title %}Analytics Dashboard - SchedShare{% endblock %}

{% block content %}
<style>
    /* Analytics Dashboard Enhancements */
    .analytics-container {
        background: var(--bg-card);
        border: 1px solid var(--border-primary);
        border-radius: 20px;
        box-shadow: var(--shadow-3d);
        position: relative;
        overflow: hidden;
    }

    .analytics-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
    }

    /* Metric Cards */
    .metric-card {
        background: var(--bg-card);
        border: 1px solid var(--border-primary);
        border-radius: 16px;
        padding: 1.5rem;
        transition: all var(--transition-normal);
        position: relative;
        overflow: hidden;
        height: 100%;
        box-shadow: var(--shadow-sm);
    }

    .metric-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, var(--accent-primary), transparent);
        opacity: 0;
        transition: opacity var(--transition-normal);
    }

    .metric-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg), 0 0 16px rgba(59, 130, 246, 0.2);
        border-color: rgba(59, 130, 246, 0.3);
    }

    .metric-card:hover::before {
        opacity: 1;
    }

    .metric-value {
        font-size: 2.5rem;
        font-weight: 700;
        background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 0.5rem;
    }

    .metric-label {
        color: var(--text-secondary);
        font-weight: 500;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .metric-change {
        font-size: 0.875rem;
        font-weight: 600;
        margin-top: 0.5rem;
    }

    .metric-change.positive {
        color: var(--accent-secondary);
    }

    .metric-change.negative {
        color: var(--accent-danger);
    }

    /* Chart Container */
    .chart-container {
        background: var(--bg-tertiary);
        border: 1px solid var(--border-primary);
        border-radius: 16px;
        padding: 2rem;
        margin-top: 2rem;
        box-shadow: var(--shadow-sm);
    }

    /* Activity Timeline */
    .activity-timeline {
        background: var(--bg-tertiary);
        border: 1px solid var(--border-primary);
        border-radius: 16px;
        padding: 2rem;
        margin-top: 2rem;
        box-shadow: var(--shadow-sm);
    }

    .timeline-item {
        display: flex;
        align-items: center;
        padding: 1rem 0;
        border-bottom: 1px solid var(--border-primary);
        transition: all var(--transition-fast);
    }

    .timeline-item:last-child {
        border-bottom: none;
    }

    .timeline-item:hover {
        background: var(--bg-card);
        border-radius: 8px;
        padding-left: 1rem;
        padding-right: 1rem;
        margin-left: -1rem;
        margin-right: -1rem;
    }

    .timeline-icon {
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1rem;
        font-size: 1.25rem;
    }

    .timeline-icon.uploads {
        background: rgba(59, 130, 246, 0.2);
        color: var(--accent-primary);
    }

    .timeline-icon.events {
        background: rgba(16, 185, 129, 0.2);
        color: var(--accent-secondary);
    }

    .timeline-icon.google {
        background: rgba(234, 67, 53, 0.2);
        color: #ea4335;
    }

    .timeline-icon.ics {
        background: rgba(255, 193, 7, 0.2);
        color: #ffc107;
    }

    .timeline-icon.email {
        background: rgba(156, 39, 176, 0.2);
        color: #9c27b0;
    }

    .timeline-content {
        flex: 1;
    }

    .timeline-title {
        color: var(--text-primary);
        font-weight: 600;
        margin-bottom: 0.25rem;
    }

    .timeline-subtitle {
        color: var(--text-secondary);
        font-size: 0.875rem;
    }

    .timeline-count {
        color: var(--accent-primary);
        font-weight: 700;
        font-size: 1.125rem;
    }

    /* Summary Stats */
    .summary-stats {
        background: var(--bg-tertiary);
        border: 1px solid var(--border-primary);
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: var(--shadow-sm);
    }

    .stat-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid var(--border-primary);
    }

    .stat-item:last-child {
        border-bottom: none;
    }

    .stat-label {
        color: var(--text-secondary);
        font-weight: 500;
    }

    .stat-value {
        color: var(--text-primary);
        font-weight: 700;
        font-size: 1.125rem;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .metric-value {
            font-size: 2rem;
        }
        
        .chart-container,
        .activity-timeline {
            padding: 1.5rem;
        }
    }
</style>

<div class="analytics-container">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="h4 fw-bold text-light mb-2">Analytics Dashboard</h2>
                <p class="text-secondary mb-0">Track usage metrics and user engagement</p>
            </div>
            <div class="text-end">
                <p class="text-muted small mb-0">Last updated: Just now</p>
            </div>
        </div>

        <!-- Summary Stats -->
        <div class="summary-stats">
            <h3 class="h5 fw-bold text-light mb-3">Key Metrics</h3>
            <div class="row">
                <div class="col-md-6">
                    <div class="stat-item">
                        <span class="stat-label">Total PDF Uploads</span>
                        <span class="stat-value">{{ total_uploads }}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Events Selected</span>
                        <span class="stat-value">{{ total_events_selected }}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Google Calendar Events</span>
                        <span class="stat-value">{{ total_google_events }}</span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="stat-item">
                        <span class="stat-label">ICS Downloads</span>
                        <span class="stat-value">{{ total_ics_downloads }}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Email Summaries</span>
                        <span class="stat-value">{{ total_emails }}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Conversion Rate</span>
                        <span class="stat-value">{{ "%.1f"|format(conversion_rate) }}%</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Today's Metrics -->
        <div class="row g-4 mb-4">
            <div class="col-md-4 col-lg-2">
                <div class="metric-card text-center">
                    <div class="metric-value">{{ today_uploads }}</div>
                    <div class="metric-label">Uploads Today</div>
                    <div class="metric-change positive">
                        <i class="bi bi-arrow-up me-1"></i>
                        PDFs processed
                    </div>
                </div>
            </div>
            <div class="col-md-4 col-lg-2">
                <div class="metric-card text-center">
                    <div class="metric-value">{{ today_events }}</div>
                    <div class="metric-label">Events Selected</div>
                    <div class="metric-change positive">
                        <i class="bi bi-calendar-check me-1"></i>
                        Courses chosen
                    </div>
                </div>
            </div>
            <div class="col-md-4 col-lg-2">
                <div class="metric-card text-center">
                    <div class="metric-value">{{ today_google }}</div>
                    <div class="metric-label">Google Events</div>
                    <div class="metric-change positive">
                        <i class="bi bi-google me-1"></i>
                        Calendar syncs
                    </div>
                </div>
            </div>
            <div class="col-md-4 col-lg-2">
                <div class="metric-card text-center">
                    <div class="metric-value">{{ today_ics }}</div>
                    <div class="metric-label">ICS Downloads</div>
                    <div class="metric-change positive">
                        <i class="bi bi-download me-1"></i>
                        Files downloaded
                    </div>
                </div>
            </div>
            <div class="col-md-4 col-lg-2">
                <div class="metric-card text-center">
                    <div class="metric-value">{{ today_emails }}</div>
                    <div class="metric-label">Email Summaries</div>
                    <div class="metric-change positive">
                        <i class="bi bi-envelope me-1"></i>
                        Emails sent
                    </div>
                </div>
            </div>
            <div class="col-md-4 col-lg-2">
                <div class="metric-card text-center">
                    <div class="metric-value">{{ "%.1f"|format(google_usage_rate) }}%</div>
                    <div class="metric-label">Google Usage</div>
                    <div class="metric-change positive">
                        <i class="bi bi-graph-up me-1"></i>
                        Of events created
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="activity-timeline">
            <h3 class="h5 fw-bold text-light mb-3">Recent Activity (Last 7 Days)</h3>
            {% if analytics.recent %}
                {% for day in analytics.recent %}
                    <div class="timeline-item">
                        <div class="timeline-icon uploads">
                            <i class="bi bi-calendar-event"></i>
                        </div>
                        <div class="timeline-content">
                            <div class="timeline-title">{{ day.date }}</div>
                            <div class="timeline-subtitle">
                                {% if day.stats.pdf_uploaded %}
                                    {{ day.stats.pdf_uploaded }} PDFs uploaded,
                                {% endif %}
                                {% if day.stats.events_selected %}
                                    {{ day.stats.events_selected }} events selected,
                                {% endif %}
                                {% if day.stats.google_events_created %}
                                    {{ day.stats.google_events_created }} Google events,
                                {% endif %}
                                {% if day.stats.ics_downloaded %}
                                    {{ day.stats.ics_downloaded }} ICS downloads,
                                {% endif %}
                                {% if day.stats.email_summary_sent %}
                                    {{ day.stats.email_summary_sent }} emails sent
                                {% endif %}
                            </div>
                        </div>
                        <div class="timeline-count">
                            {{ day.stats.values()|map('int')|sum }}
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-calendar-x text-muted fs-1 mb-3"></i>
                    <p class="text-muted">No recent activity</p>
                </div>
            {% endif %}
        </div>

        <!-- Provider Usage Chart -->
        <div class="chart-container">
            <h3 class="h5 fw-bold text-light mb-3">Provider Usage</h3>
            <div class="row">
                <div class="col-md-6">
                    <div class="d-flex align-items-center mb-3">
                        <div class="bg-danger bg-opacity-20 rounded-circle p-2 me-3">
                            <i class="bi bi-google text-danger"></i>
                        </div>
                        <div>
                            <div class="fw-bold text-light">Google Calendar</div>
                            <div class="text-secondary small">{{ total_google_events }} events created</div>
                        </div>
                        <div class="ms-auto">
                            <span class="badge bg-danger">{{ "%.1f"|format(google_usage_rate) }}%</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="d-flex align-items-center mb-3">
                        <div class="bg-warning bg-opacity-20 rounded-circle p-2 me-3">
                            <i class="bi bi-download text-warning"></i>
                        </div>
                        <div>
                            <div class="fw-bold text-light">ICS Downloads</div>
                            <div class="text-secondary small">{{ total_ics_downloads }} files downloaded</div>
                        </div>
                        <div class="ms-auto">
                            <span class="badge bg-warning">{{ "%.1f"|format(ics_usage_rate) }}%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Auto-refresh analytics every 5 minutes
    setTimeout(() => {
        window.location.reload();
    }, 300000);

</script>
{% endblock %}
