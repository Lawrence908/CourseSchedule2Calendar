{% extends "base.html" %}

{% block title %}Your Events - Schedule2Calendar{% endblock %}

{% block content %}
<div class="card shadow">
    <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-3">
            <h2 class="h5 fw-bold text-light">Identified Events</h2>
            <button id="toggleEvents" class="btn btn-sm btn-outline-light" type="button">
                <span id="arrowIcon" class="bi bi-chevron-down"></span>
            </button>
        </div>
        <div id="eventsSection">
        {% if filename %}
        <div class="d-flex align-items-center mb-3">
            <img src="/static/pdf-icon.png" alt="PDF" style="height: 1.5rem; width: 1.5rem;" class="me-2">
            <span class="text-light small">{{ filename }}</span>
        </div>
        {% endif %}
        <form id="eventForm" action="{{ url_for('create_selected_events') }}" method="POST">
            <input type="hidden" name="selected" id="selectedInput" />
            <div class="row g-3">
                {% for course in courses %}
                <div data-index="{{ loop.index0 }}" class="col-md-6 col-lg-4">
                    <div class="card h-100 event-card bg-secondary bg-opacity-25 text-light border-0 shadow-sm cursor-pointer">
                        <div class="card-body">
                            <h3 class="h6 fw-bold text-primary mb-2">{{ course['Course'] }}</h3>
                            <p class="mb-1"><strong>Section:</strong> {{ course['Section'] }}</p>
                            <p class="mb-1"><strong>Instructor:</strong> {{ course['Instructor'] }}</p>
                            <p class="mb-1"><strong>Location:</strong> {{ course['Location'] }}</p>
                            <p class="mb-1"><strong>Days:</strong> {{ course['Days'] }}</p>
                            <p class="mb-1"><strong>Time:</strong> {{ course['Start'] }} - {{ course['End'] }}</p>
                            <p class="mb-1"><strong>Start:</strong> {{ course['StartDate'] }} | <strong>End:</strong> {{ course['EndDate'] }}</p>
                            <p class="text-muted small mb-0">Status: {{ course['Status'] }} | Mode: {{ course['DeliveryMode'] }}</p>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="mt-4 text-end">
                <button type="submit" class="btn btn-primary" id="createBtn" disabled>Create Selected Events</button>
            </div>
        </form>
        </div>
        {% if created_events %}
        <div class="mt-5">
            <h3 class="h6 fw-bold text-success mb-2">Created Events</h3>
            <ul class="list-group mb-4">
                {% for event in created_events %}
                <li class="list-group-item bg-dark text-light">
                    <a href="{{ event.htmlLink }}" class="text-primary text-decoration-underline" target="_blank">{{ event.summary }}</a>
                </li>
                {% endfor %}
            </ul>
            <!-- Email and ICS download section -->
            <div class="mb-3">
                <form action="{{ url_for('send_email_summary') }}" method="POST" class="mb-2 d-flex flex-column align-items-center gap-2">
                    <label for="email" class="form-label">Send a summary to your email:</label>
                    <input type="email" name="email" id="email" required class="form-control w-auto" placeholder="you@email.com" />
                    <button type="submit" class="btn btn-primary">Send Email</button>
                    <span class="text-muted small mt-1">We only use your email to send this summary. <a href="/privacy" class="text-decoration-underline">Privacy Policy</a></span>
                </form>
                <form action="{{ url_for('download_ics') }}" method="POST" class="text-center">
                    <button type="submit" class="btn btn-success">Download ICS for Apple/Outlook</button>
                </form>
                {% if email_sent %}
                <div class="mt-2 alert alert-success p-2">Email sent successfully!</div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const cards = document.querySelectorAll('.event-card');
        const selectedInput = document.getElementById('selectedInput');
        const createBtn = document.getElementById('createBtn');
        const selectedSet = new Set();
        const toggleBtn = document.getElementById('toggleEvents');
        const eventsSection = document.getElementById('eventsSection');
        const arrowIcon = document.getElementById('arrowIcon');

        function updateForm() {
            selectedInput.value = Array.from(selectedSet).join(',');
            createBtn.disabled = selectedSet.size === 0;
        }

        cards.forEach((card, idx) => {
            card.addEventListener('click', () => {
                const index = card.parentElement.getAttribute('data-index');
                if (selectedSet.has(index)) {
                    selectedSet.delete(index);
                    card.classList.remove('border-primary', 'border-3');
                } else {
                    selectedSet.add(index);
                    card.classList.add('border-primary', 'border-3');
                }
                updateForm();
            });
        });

        if (toggleBtn && eventsSection && arrowIcon) {
            toggleBtn.addEventListener('click', () => {
                eventsSection.classList.toggle('d-none');
                arrowIcon.classList.toggle('bi-chevron-up');
                arrowIcon.classList.toggle('bi-chevron-down');
            });
        }
    });
</script>
{% endblock %} 